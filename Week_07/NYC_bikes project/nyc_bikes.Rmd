---
title: "NYC Bikes Project - Kirsty Anderson"
output: html_notebook
---

```{r}
library(tidyverse)
library(tsibbledata)
library(tsibble)
library(leaflet)
library(fontawesome)
```

```{r}
nyc_bikes_df <- nyc_bikes
```

create columns for start/stop day, month, year, weekday, time duration (minutes):

```{r}
nyc_bikes_df <- nyc_bikes_df %>% 
  mutate(
    start_year = year(start_time),
    start_month = month(start_time),
    start_day = day(start_time),
    start_wkday = wday(start_time, label = TRUE, abbr = TRUE),
    stop_year = year(stop_time),
    stop_month = month(start_time),
    stop_day = day(stop_time),
    stop_wkday = wday(stop_time, label = TRUE, abbr = TRUE),
    time_duration = as.duration(stop_time - start_time),
    time_duration = round(as.numeric(time_duration, "minutes"), digits = 2),
    start_date= make_date(start_year, start_month, start_day),
    stop_date= make_date(stop_year, stop_month, stop_day),
    start_hour = hour(start_time),
    stop_hour = hour(stop_time)
  )


```


```{r}

nyc_bikes_df %>% 
  group_by(start_wkday) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = start_wkday, y = count)) +
  geom_col()
```



```{r}

nyc_bikes_df %>% 
  group_by(start_hour) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = start_hour, y = count)) +
  geom_line() +
  scale_x_continuous(breaks = 0:24)
```

```{r}
nyc_bikes_df %>% 
  group_by(stop_hour) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = stop_hour, y = count)) +
  geom_line() +
  scale_x_continuous(breaks = 0:24)
```
```{r}
nyc_bikes_df %>% 
  filter(start_month == 8) %>% 
  mutate(start_wkday = as.character(start_wkday)) %>% 
  group_by(start_wkday) %>% 
  summarise(count_day = n()) %>% 
  ggplot(aes(x = start_wkday, y = count_day)) +
  geom_col() #+
  #scale_x_continuous(breaks = 0:24)
```
```{r}
nyc_bikes_df %>% 
  filter(start_month == 8) %>% 
  index_by(start_date) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = start_date, y = count)) +
  geom_line() +
  scale_x_continuous(breaks = 1:31)
```

# What is the pattern of bike hires over time (e.g. within a year, month, week, or day)?


## - within a year

```{r}

nyc_bikes_df %>% 
  ggplot(aes(x = start_date)) +
  geom_histogram()

```

```{r}
nyc_bikes_df %>% 
  group_by(start_month) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = start_month, y = count)) +
  geom_col() +
  scale_x_continuous(breaks = 1:12)
```


## - within a month


```{r}
nyc_bikes_df %>% 
  group_by(start_month) %>% 
  group_by(start_day)
  ggplot(aes(x = start_month, y = count, group = start_month)) +
  geom_line(colour = start_month)
```
```{r}
months <- as.list( nyc_bikes_df %>% 
  distinct(start_month))
```

```{r}
class(months)
```


```{r}
month_check <- for(x in months){
  nyc_bikes_df %>% 
    filter(start_month == x) %>% 
    group_by(start_day) %>% 
    summarise(count = n())
}
```

```{r}
nyc_bikes_df_month <- nyc_bikes_df %>% 
  index_by(day = (start_day)) %>% 
  group_by(start_month) %>% 
  summarise(count = n())
```

```{r}
nyc_bikes_df_month %>% 
  ggplot(aes(x = day, y = count, group = as.character(start_month), colour = as.character(start_month)))+
  geom_line() +
  facet_wrap(~start_month)
```



## - within a week 
```{r}
nyc_bikes_df %>% 
 index_by(start_wkday) %>% 
  summarise(mean = mean(n())) %>% 
  ggplot(aes(x = start_wkday, y = mean)) +
    geom_col()

```
# within a week: split by type

```{r}
nyc_bikes_df %>% 
  index_by(start_wkday) %>%
  group_by(type) %>% 
  summarise(mean = mean(n())) %>% 
  ggplot(aes(x = factor(start_wkday, 
                        level = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")), 
             y = mean, 
             fill = type)) +
  geom_col() +
  xlab("\nDay") +
  ylab("Hires\n") +
  labs(fill = "Type of Hire\n") +
  ggtitle("Average Daily Bike Hires by Hire Type") +
  theme_minimal() +
  scale_fill_manual(values = c("Subscriber" = "#343d72",
                               "Customer" = "#3d99ce")) +
  theme(plot.title = element_text(family = "sans", face = "bold", hjust = 0.5))+
       
  ylim(0,750)
```

## - within a day
```{r}
nyc_bikes_df %>% 
 index_by(start_hour) %>% 
  summarise(mean = mean(n())) %>% 
  ggplot(aes(x = factor(start_hour, level = c(6:23, 0)), y = mean)) +
    geom_col()
```

```{r}
nyc_bikes_df_day <- nyc_bikes_df %>% 
  mutate(day_type = ifelse(start_wkday %in% c("Sat", "Sun"), "Weekend", "Weekday")) %>% 
  group_by(day_type) %>% 
  index_by(start_hour) %>% 
  summarise(count = n()) 

nyc_bikes_df_day <- nyc_bikes_df_day %>% 
  mutate(label_text = ifelse(count %in% c(474, 377), paste0(start_hour,":00"), NA))
  
  nyc_bikes_df_day %>% 
  ggplot(aes(x = factor(start_hour, level = c(1:23, 0)), y = count, group = day_type, colour = day_type)) +
  geom_point() +
  geom_text(aes(label = label_text), vjust = -1) + 
    geom_line() +
  xlab("\nHour") +
  ylab("Hires\n") +
  labs(colour = "Weekday/ Weekend\n") +
  ggtitle("Average Hourly Hires per Day") +
  theme_minimal() +
  scale_colour_manual(values = c("Weekday" = "#343d72",
                               "Weekend" = "#dd3239")) +
  theme(plot.title = element_text(family = "sans", face = "bold", hjust = 0.5))+
       
  ylim(0,750)
```



# Do bike hire patterns differ between bike rider demographics? (e.g. gender, type of trip, age)

## age

```{r}
nyc_bikes_df %>% 
  index_by(birth_year) %>% 
  filter(!birth_year %in% c(1887, 1888)) %>% # remove 2 rows containing impossible ages
  summarise(count = n()) %>% 
  ggplot(aes(x = birth_year, y = count)) +
  geom_col()
```

## gender 

```{r}
nyc_bikes_df %>% 
  index_by(birth_year) %>% 
  filter(!birth_year %in% c(1887, 1888)) %>% # remove 2 rows containing impossible ages
  group_by(gender) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = birth_year, y = count)) +
  geom_col() +
  facet_wrap(~gender)
```


### - now do year/month/week/day for each gender

####- within a year

```{r}

nyc_bikes_df %>% 
  group_by(gender) %>% 
  ggplot(aes(x = start_date)) +
  geom_histogram() +
  facet_wrap(~gender)

```


#### - within a month
```{r}
nyc_bikes_df %>% 
  index_by(day = (start_day)) %>% 
  group_by(start_month, gender) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = day, y = count, group = as.character(start_month), colour = gender))+
  geom_line() +
  facet_grid(gender~start_month)
```



#### - within a week 
```{r}
nyc_bikes_df %>% 
 index_by(start_wkday) %>% 
  group_by(gender) %>% 
  summarise(mean = mean(n())) %>% 
  ggplot(aes(x = start_wkday, y = mean)) +
    geom_col() +
  facet_wrap(~gender)

```

#### - within a day
```{r}
nyc_bikes_df %>% 
 index_by(start_hour) %>% 
  group_by(gender) %>% 
  summarise(mean = mean(n())) %>% 
  ggplot(aes(x = start_hour, y = mean)) +
    geom_col() +
  facet_wrap(~gender)
```

## types of trips

```{r}
nyc_bikes_df %>% 
  group_by(type) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = type, y = count)) +
  geom_col() 
```


#### - within a year

```{r}

nyc_bikes_df %>% 
  group_by(type) %>% 
  ggplot(aes(x = start_date)) +
  geom_histogram() +
  facet_wrap(~type)

```







#### - within a month
```{r}
nyc_bikes_df %>% 
  index_by(day = (start_day)) %>% 
  group_by(start_month, type) %>% 
  summarise(count = n()) %>% 
  ggplot(aes(x = day, y = count, group = as.character(start_month), colour = type))+
  geom_line() +
  facet_grid(type~start_month)
```



#### - within a week 
```{r}
nyc_bikes_df %>% 
 index_by(start_wkday) %>% 
  group_by(type) %>% 
  summarise(mean = mean(n())) %>% 
  ggplot(aes(x = start_wkday, y = mean)) +
    geom_col() +
  facet_wrap(~type)

```

#### - within a day
```{r}
nyc_bikes_df %>% 
 index_by(start_hour) %>% 
  group_by(type) %>% 
  summarise(mean = mean(n())) %>% 
  ggplot(aes(x = start_hour, y = mean)) +
    geom_col() +
  facet_wrap(~type)
```
# What is the geographical spread of the start points of bike hires?

```{r}
icon <- makeAwesomeIcon(icon = "bicycle", library = "fa", markerColor = "blue", iconColor = "red")
nyc_bikes_df %>%
  distinct(start_lat, start_long) %>% 
  leaflet() %>% 
  addTiles() %>% 
  addAwesomeMarkers(lng = ~start_long,
                    lat = ~start_lat,
                    icon = icon,
                    clusterOptions = markerClusterOptions(),
  )

```


```{r}
leaflet_data_100 <- as.tibble(nyc_bikes_df) %>% 
  mutate(coord = paste(start_lat, start_long, sep = ", "), .after = start_long) %>% 
  group_by(coord, start_lat, start_long) %>% 
  summarise(count = n()) %>% 
  filter(count > 100)
leaflet_data_100 %>% 
  leaflet() %>% 
  addTiles() %>% 
  addAwesomeMarkers(lng = ~start_long,
                    lat = ~start_lat,
                    icon = icon,
                    popup = ~count) %>% 
 addLabelOnlyMarkers(~start_long, ~start_lat, label =  ~as.character(count), 
                      labelOptions = labelOptions(noHide = T, direction = 'top', textOnly = T))
  
```

